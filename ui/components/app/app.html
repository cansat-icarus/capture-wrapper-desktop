
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../lib/app-header-layout.html">
<link rel="import" href="../indicator/station-score-small.html">
<link rel="import" href="drawer.html">
<link rel="import" href="header-tools.html">
<link rel="import" href="main.html">

<link rel="import" href="../../lib/style.html">

<dom-module id="cg-app">
  <template>
    <style include="iron-flex">
      app-header-layout {
        position: relative;
      }

      app-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
        -webkit-app-region: drag;
        -webkit-user-select: none;
      }

      app-header {
        z-index: 2;
      }

      app-drawer {
        -webkit-app-region: no-drag;
      }

      paper-icon-button {
        -webkit-app-region: no-drag;
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      #headerTools {
        padding: 0 1em 1em;
      }

      #headerTools, #header-station-score-spacer {
        z-index: 1;
      }

      #header-station-score-spacer {
        height: 10px;
      }

      #smallIndicator, #smallScore {
        margin-right: 0.5em;
      }

      #smallScore, #smallIndicator, #headerTools {
        will-change: transform;
        transition: 0.2s transform;
      }

      .shrink-to-0 {
        transform: scale3d(0, 0, 0);
      }
    </style>

    <app-drawer-layout fullbleed responsive-width="750px">
      <app-drawer>
        <app-toolbar>Backend Connection</app-toolbar>
        <cg-drawer></cg-drawer>
      </app-drawer>

      <cg-app-header-layout fullbleed>
        <app-header condenses fixed effects="waterfall" id="header">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>Icarus CanSat Ground Station</div>
            <cg-status-indicator
              id="smallIndicator"
              color="{{statusColor}}"
              class="shrink-to-0">{{statusText}}</cg-status-indicator>
            <cg-station-score-small id="smallScore" class="shrink-to-0"></cg-station-score-small>
            <paper-icon-button id="maximizeToggleBtn" icon="fullscreen" on-click="_maximizeToggle"></paper-icon-button>
            <paper-icon-button icon="close" on-click="_close"></paper-icon-button>
          </app-toolbar>
          <cg-header-tools id="headerTools" status-color="{{statusColor}}" status-short-text="{{statusText}}"></cg-header-tools>
          <div id="header-station-score-spacer"></div>
        </app-header>

        <cg-main></cg-main>
      </cg-app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'cg-app',
      _maximizeToggle () {
        CGBridge.emit('maximize')
      },
      _close () {
        CGBridge.emit('close')
      },
      ready () {
        // Fix dangling white stripes on the side of the header...
        setTimeout(() => window.dispatchEvent(new Event('resize')), 500)

        // Change button icon when maximized/unmaximize
        CGBridge.on('maximize', maximized => this.$.maximizeToggleBtn.icon = maximized ? 'fullscreen-exit' : 'fullscreen')

        // Hide/show things on the collapsing header
        window.addEventListener('scroll', () => {
          setImmediate(() => {
            const progress = this.$.header.getScrollState().progress

            this.$.smallScore.classList.toggle('shrink-to-0', progress <= 0.5)
            this.$.smallIndicator.classList.toggle('shrink-to-0', progress <= 0.5)
            this.$.headerTools.classList.toggle('shrink-to-0', progress > 0.5)
          })
        })
      }
    })
  </script>
</dom-module>
